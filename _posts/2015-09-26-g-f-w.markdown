---
layout: post
title:  "［科普］网络故障"
author: vjudge1
categories: Web
---
* content
{:toc}

为什么有些网站，例如百度、新浪微博和人人网<span class="blackout">所抄袭的对象</span>，它们明明就在那里，但是就是进不去？

难道是网络故障吗？原因大家<s>肯定都懂得</s>其实不一定懂，因此本文将科普一些更详细的知识。






# 备注

为了方便叙述，后文将把那个你懂得的东西叫做<s>墙</s>出口检测设备。

国内的网络连接不经过这个设备，只有出国或者回国的时候才会经过这个设备。在国内根本不需要类似的设备<span class="blackout">只需要一些叔叔就能彻底解决问题了</span>。

“出口检测设备”大约于 1998 年成立，作者是大名鼎鼎的方<span class="blackout">滨兴</span>校长。

那么设备由谁主管呢？这个没有人知道，但是他不告诉我们到底是谁。我猜这个人应该姓阎<span class="blackout">，因为我们曾经派了一些人去打听相关的事儿，但是他们都从来没有回来过</span>。

# 网络故障的原因

回到正题，为什么有些网站进不去？原因有很多种，本文将一一介绍。

## 如果一切正常

当我们要去一个地方的时候，例如北京邮电大学<small>（相当于“域名”）</small>，我们当然需要知道地址，或者知道“怎么走”<small>（也就是“路由”）</small>才能过去。

[% callout %]
北京邮电大学

北京邮电大学那么小，小到不比你的高中校园大多少的程度，为什么还要拿它举例子呢？因为它是革命圣地——出口检测设备的诞生地！
[% endcallout %]

当我们第一次去北京的时候，我们当然需要问路<small>（“DNS 查询”）</small>。问路的目标有很多——你可以问:cop:叔叔，也可以问路边开小卖店的，当然也可以直接给北京邮电大学打电话。这些不同的人，就相当于不同的 DNS 服务器。<small>（因此有的时候能登上 QQ 但是打不开网页，就是因为你想找叔叔问路但是周围没有叔叔，所以你当然要换个人来问——换 DNS 服务器。）</small>

如果:cop:叔叔或者什么人知道北京邮电大学在哪儿，他就会回答你，并且告诉你北京邮电大学在“北京市海淀区西土城路 10 号”<small>（正确的 IP 地址）</small>。

当然找的时候就是“从北京站乘坐地铁 2 号线，到达车公庄站，从地铁东南口出，步行约160米，到达车公庄北站，乘坐 632 到达明光桥北站，向北步行即可到达北京邮电大学西门”<small>（路由）</small>。因为地址是正确的，所以只要按照这条路线走，就肯定能找到北京邮电大学。

## 第一种故障 (DNS poisoning)

事实上，有些北京人比较排外<span class="blackout">或者他们是已经知道你的底细的北京朝阳群众</span>，尤其排斥东北人，觉得你不应该去北京邮电大学<span class="blackout">打出口检测设备的主意</span>，所以，当你问路的时候会告诉你一个错误的地方，例如“北京市顺化区长青路45号”<small>（很明显是一个根本不存在的 IP 地址）</small>。近些年来，他们也会告诉你一个貌似正确，实际上并不正确的地方，如“北京市昌平区府学路27号”<small>（中国政法大学——错误但确实存在的 IP 地址）</small>。

很多网站上不去，原因就是这么:hankey:简单。

![dns]({{site.baseurl}}/images/2015-09-26-gfw2/dnspoisoning.jpg)
<br><small>别有用心的路牌——就是这个意思</small>

那么，直接给北邮打电话<small>（把 DNS 服务器设置成国外的）</small>不就可以知道准确的地址了吗？但是很遗憾，出口检测设备的技术已经高到可以直接换地址的程度了——北邮的工作人员告诉你是“海淀区”，但是你接电话的时候听到的仍然是“昌平区”。

因此有些网站需要自己找到正确的地址才能访问。

[% callout %]
判断方法

可以使用 nslookup 命令查询和判断是否有人误导你，给你指出了错误的路，例如

    nslookup www.baidu.com

如果想测试其他 DNS 服务器，使用

    nslookup www.baidu.com 114.114.114.114

将得到的 IP 结果到百度上查一查，看看到底是否靠谱。一般情况下，只要那个网站上不去，基本上 IP 都是不靠谱的。
[% endcallout %]

[% callout %]
怎样才能找到呢？

在线 nslookup 网站（online nslookup）那么多，为什么不找一个靠谱的查一查呢？

查完记得 Ping 一下，因为……
[% endcallout %]

## 第二种故障 (IP block)

毕竟问路效果有限<small>（如果自己知道地址就可以自己去找了）</small>，所以为了取得更好的效果，可以直接把路拆了。这种事儿铁道游击队做得太多了。

所以，只要把通向北邮的道路全部拆掉<small>（IP block）</small>，即使你知道北邮在哪儿你照样过不去。

![ip]({{site.baseurl}}/images/2015-09-26-gfw2/ipblock.jpg)
<br><small>百度就在路的那面，有本事过去啊</small>

[% callout %]
判断方法

很简单，ping 一下就知道有没有路了。

    ping 192.168.1.1

如果想知道详情，可使用 traceroute（tracert）命令。
[% endcallout %]

有的时候，路并没有完全拆毁，只是不太好走而已。

## 第三种故障 (Keyword filter)

还记得多少年前用百度<span class="blackout">所抄袭的那个网站</span>搜索一点东西，搜着搜着就“连接已<s>重置</s>充值”了吧？

普通的网页传输采用 HTTP 协议。这就好比上街的时候不拿兜子或背包，直接拿着东西走——你拿了什么，路人<span class="blackout">和朝阳群众</span>一目了然。

[% callout %]
明文传输

在网页里输入密码，密码看不见，对吧？提交表单，提交内容看不见，对吧？在此必须要提醒你，其实挡上了也是明文——防君子不防小人而已。

当然，HTTP 也没危险到任何人都能截获，要不然人们就不会用这个协议了。但是，如果一个别有用心的人在你的网络访问的路上设了关卡，例如钓鱼热点，那么你的安全将不复存在，因为明文传输意味着他可以看得清清楚楚。就像下图一样：

![http]({{site.baseurl}}/images/2015-09-26-gfw2/http.png)
[% endcallout %]

2002 年诞生了一项新技术<span class="blackout">北京朝阳群众技术</span>：

如果你拿的是正常的东西，那么在大街上走路的时候当然不会有问题。但是，如果你拿了一些不该拿的东西，例如:bomb:或者一本封面上阿姨没穿衣服的书<small>（传输过程中出现关键词）</small>，那么有人<span class="blackout">朝阳群众</span>自然有事情做了——请:cop:叔叔来找你<small>（触发关键词，连接中断）</small>。

![telescreen]({{site.baseurl}}/images/2015-09-26-gfw2/telescreen.jpg)
<br><small>一点遮挡都没有，老大哥当然可以看得清清楚楚</small>

需要注意的是，即使你找到了正确的路，但是你穿着印有星星月亮<span class="blackout">恐怖组织标志</span>和一些虫子:bug:<span class="blackout">阿拉伯文</span>的衣服到处乱转，:cop:叔叔当然会找你:new_moon_with_face:。<small>（即 IP 正确，但是因为 HTTP 协议中的“Host: ?????.com”是明文，所以同样触发了关键词。）</small>

![terrorist]({{site.baseurl}}/images/2015-09-26-gfw2/terrorist.jpg)
<br><small>暴露了自己的恐怖分子的身份，那么随便几个群众都能把你制服</small>

好在目前 HTTPS 协议不受此影响<small>（上街的时候把东西放背包里，谁知道你拿了什么？）</small>因此对于采用 HTTPS 的网站，出口检测设备需要采取其他手段。

[% callout %]
安全建议

尽量不要连接公共 Wifi。如果必须要用，建议用 VPN（仅仅是为了加密连接，不要想太多）。因为即使你可以保证只用 HTTPS，但是你要访问的网站和你所用的软件不能。
[% endcallout %]

## 其他影响

凡是出国途中遇到问题，都是上面提到的原因——

1. 有些时候苹果 App Store 或者 Windows 应用商店会经常出现故障。
2. 很多外国网页加载速度奇慢无比，因为负责网页样式的代码都被放到那些“看起来不存在”的地方里面了。所以，在网页卡着的时候，浏览器事实上已经知道该输出什么文字，只不过不知道应该以什么颜色、样式输出<span class="blackout">浏览器哪儿知道什么出口检测设备</span>，所以当然是一片空白（或者是一堆没有样式的文字）。

# 解决故障的思路

其实大家最关心的是，怎样才能解决网络故障。下面是一点点提示：

## HTTPS

感谢爱德华·斯诺登，他让我们在解决某些问题方面变得更加轻松——2014 年，国外很多主要网站已经全面采用 HTTPS。国内有一部分网站也采用了 HTTPS。

国内为什么不普及呢？估计有两个原因：一是证书太贵了，二是太麻烦而且还没有用<span class="blackout">反正一切都是国家的</span>。

HTTPS 有什么好处呢？接着前面的例子讲——

我们说，采用 HTTP 传输就好比上大街直接拿着东西走，所以拿着什么别人看得清清楚楚。

HTTPS 就相当于上街时背个包，把东西放包里面（加密）。怎么装的只有双方知道，所以路人<span class="blackout">包括朝阳群众</span>当然不知道你带了什么东西，也管不了你。

![a]({{site.baseurl}}/images/2015-09-26-gfw2/87f159bf-d869-4345-9f31-0553e80b65f2.jpg)
<br><small>我什么都不知道<span class="blackout">。谁知道包里面是不是炸弹呢</span>——这就是 HTTPS<a href="http://epaper.cqcb.com/html/2014-07/04/content_121984.htm">（图片来源）</a></small>

自从 HTTPS 大规模普及，事实上已经成为了一个解决网络故障的原理。

## IPv6

由于 IPv6 是一个全新的协议，所以出口检测设备拿它也没办法。没准 IPv6 就是这个原因才没有被大规模推广。

但是，注意，这不代表使用 IPv6 就可以万事大吉了——因为访问 IPv6 网站也要像前文提到的那样去“问路”，所以得到的结果照样有可能是错的。

你仍然需要知道网站的正确地址才能访问。这样的话，如果 IPv4 地址是可以使用的，IPv4 和 IPv6 就没有太大区别了。不过 IPv6 速度更快而且不受干扰。

[% callout style=warning %]
IPv6 隧道

IPv6 没问题对吧？但是隧道可不是——隧道是不加密的，该断当然就断了。所以不要拿隧道当梯子使！
[% endcallout %]

[% callout %]
4+6=2

知道那个可以用来屏蔽广告<span class="blackout">其实是用来出国</span>的 Hosts 吧？其实，你可以同时给一个域名指定多个 IP——既有 IPv4 又有 IPv6！
[% endcallout %]

## 鸡毛信

这是一个重点。

知道鸡毛信的故事吧？在抗战时期，我们当然会用一些暗语来与自己人交流，尤其是地下工作者，要不然……采用类似的方法，即使见到鬼子面了，情报也不会被鬼子<span class="blackout">直接</span>截获。

![a]({{site.baseurl}}/images/2015-09-26-gfw2/encrypt.jpg)
<br><small>太君只能看到一群羊——谁知道羊身上还藏着情报</small>

VPN、G<span class="blackout">oAgen</span>t、S<span class="blackout">hadowsSoc</span>ks<span class="blackout">、目油们</span>等都是这样的东西<span class="blackout">，只不过 VPN 只要能和有关部门合作就合法，而其他的都不合法</span>。

我们建议，如果你真的是为了学术用途，建议你花钱买个合法的 VPN<span class="blackout">，因为合法的 VPN 不会被++但是会记录你的浏览记录</span>。又稳定又方便。

# 规避风险

知道如何解决网络故障，但是也需要知道怎样规避风险。

## Protocol detecting

智能家居从墙开始——

有了机器学习技术作为支撑，出口检测设备已经能够识别各种 VPN、Gt、Sks 等流量。至于会不会++那些流量，全凭设备的心情<span class="blackout">，可能是有一个阈值，只要流量足够大就切断</span>。

<small>鸡毛信送多了，鬼子当然知道羊是用来送信的了，只不过，想不想“三光”全凭心情。</small>

## 探测

你以为墙只是一种用来支撑房子的东西吗？那是因为你没看过正大综艺《墙来了》！

《墙来了》里的墙就可以主动地找你。可能出口检测设备就是受了 <s>CCAV</s>CCTV 的启发，也开发了主动找你的功能。

有关事项 Tor 项目已经做了深入研究，我们就不研究了。

## 办假证

见过路边“办证”的小广告吧？

别以为小广告都是骗人的——出口检测设备也找过这些办证的<span class="blackout">，要不然为什么总有人想着要删除 CNNIC CA 呢</span>。

因此，在访问网站时，如果浏览器提示“证书无效”，那么你一定要停下来，不要再继续，因为假证可以用来监听和干预！

[% callout %]
12306 除外

12306 的证书是自己给自己颁发的，所以当然是假证了。自己制作证书，省钱啊:wink:！
[% endcallout %]

![a]({{site.baseurl}}/images/2015-09-26-gfw2/fakecert1.png)
<br><small>千万不要继续，更不要信任假证书！</small>

![a]({{site.baseurl}}/images/2015-09-26-gfw2/fakecert2.png)
<br><small>因为一旦继续，老大哥就可以知道你在看什么了（没有证书就看不到）</small>

![a]({{site.baseurl}}/images/2015-09-26-gfw2/fakecert3.png)
<br><small>甚至对你恶搞一下</small>

[% callout %]
关于 CNNIC

因为 CNNIC 黑历史比较多<span class="blackout">，没准 CNNIC 和某些设备是一伙儿的</span>，所以大家都不太相信他们。2015 年 3 月，CNNIC 的一个在埃及的中间证书颁发机构伪造了 G<span class="blackout">mail</span> 的证书，结果很快 Chrome、Firefox、Apple 等就不再信任 CNNIC CA 了。
[% endcallout %]

# 不为人知的事情

很多人以为出口检测设备只是一个检测设备，其实它还是一个非常先进的武器，俗称“大炮”。

因为中国除了人多就是人多，所以，只要随便找个大流量网站（比如 <s>12306</s>百度统计），稍微加点攻击的代码，那么——绝对是难以招架的 DDoS:scream:！

[% callout %]
所以说……

以后想摧毁哪个反<span class="blackout">共</span>华组织的网站，只要在春节之前往 12306 网站里加入攻击代码……春节快乐！
[% endcallout %]

由于潜力巨大，2015 年 3 月末，设备首次对 GitHub 小试牛刀。这次试验取得了<span class="blackout">白白激怒了全世界软件开发人员，没有任何</span>实际效果。

[% callout %]
补充说明

由于对百度代码的修改作用发生在出口检测设备上面，因此国内访问百度并不会产生类似的攻击效果。在 GitHub 遭攻击之后不久，百度所有产品差不多都采用了 HTTPS<span class="blackout">，这样百度就不会再次被当作武器来使用了</span>。
[% endcallout %]

# 其他

以下方法从技术上讲都是可以实现的<span class="blackout">，有些是出口检测设备曾经用过的</span>，只不过现在设备没大规模使用而已。

1. 不是彻底把路弄断，而是隔几分钟就开一下，给人一种不稳定的感觉。
2. 禁止发邮件。
3. 直接切断连接。
4. 发现指定证书后切断连接。（因为公钥未加密）
5. 切断指定端口，如 22、443……
